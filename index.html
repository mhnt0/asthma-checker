<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>喘息注意度チェッカー</title>
<meta name="theme-color" content="#0b3d5c" />
<style>
  :root{
    --bg:#0b1116; --fg:#e9f1f5; --muted:#9bb3bf; --card:#121a21;
    --ok:#12b886; --med:#ffd43b; --hi:#ff922b; --vhi:#fa5252; --accent:#2a84ff;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f5fbff; --fg:#0c1b24; --muted:#5b7480; --card:#ffffff; }
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
        background:var(--bg); color:var(--fg); }
  header{ padding:16px; position:sticky; top:0; z-index:3;
          backdrop-filter:saturate(1.2) blur(6px);
          background:color-mix(in oklab, var(--bg) 84%, transparent);
          border-bottom:1px solid color-mix(in oklab,var(--fg) 12%, transparent);}
  h1{ font-size:18px; margin:0; }
  main{ padding:16px; display:grid; gap:16px; max-width:720px; margin:0 auto; }
  .card{ background:var(--card); border:1px solid color-mix(in oklab,var(--fg) 10%, transparent);
         border-radius:14px; padding:14px; }
  .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }

  /* ===== Footer ===== */
  footer.site-footer{
    margin:28px auto 12px; max-width:720px; padding:14px 12px;
    background:color-mix(in oklab, var(--card) 70%, var(--bg) 30%);
    border:1px solid color-mix(in oklab,var(--fg) 10%, transparent); border-radius:14px;
  }
  .footer-row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  .footer-title{ font-size:12px; color:var(--muted); margin:0 0 8px 2px; }
  .footer-chip{
    display:inline-flex; align-items:center; justify-content:center;
    padding:10px 14px; min-height:44px; border-radius:999px;
    border:1px solid color-mix(in oklab,var(--fg) 12%, transparent);
    background:color-mix(in oklab,var(--bg) 70%, var(--card) 30%); color:var(--fg);
    text-decoration:none; font-size:14px;
  }
  .footer-chip:active{ transform:scale(.98); }
  .footer-sep{ height:1px; width:100%; margin:8px 0;
    background:color-mix(in oklab,var(--fg) 10%, transparent); border:0; }
  .footer-chip.legal{ color:var(--muted); background:transparent; }

  /* Buttons */
  button{ font-size:16px; padding:12px 14px; border-radius:12px;
          border:1px solid color-mix(in oklab,var(--fg) 10%, transparent);
          background:color-mix(in oklab,var(--bg) 70%, var(--card) 30%);
          color:var(--fg); cursor:pointer; transition:.15s; }
  button:active{ transform:scale(0.97); }
  button.loading{ opacity:.6; pointer-events:none; }
  button.activeTab{ background:var(--accent); color:white; }

  .muted{ color:var(--muted); font-size:13px; }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .kpi{ display:flex; flex-direction:column; gap:4px; padding:10px; border-radius:12px;
        background:color-mix(in oklab,var(--card) 70%, var(--bg) 30%); }
  .kpi b{ font-size:18px; }

  .pill{ padding:4px 10px; border-radius:999px; font-weight:700; font-size:13px; }
  .pill.low{ background:color-mix(in oklab, var(--ok) 25%, transparent); color: var(--ok);}
  .pill.mod{ background:color-mix(in oklab, var(--med) 25%, transparent); color:#a07b00;}
  .pill.high{ background:color-mix(in oklab, var(--hi) 25%, transparent); color:#a35300;}
  .pill.vhi{ background:color-mix(in oklab, var(--vhi) 25%, transparent); color:#8a0b0b;}

  /* Gauge */
  .gauge{ width:100%; aspect-ratio:2.2/1; overflow:visible; display:block; }

  .tiny{ font-size:12px; }
  .toast{ position:fixed; left:12px; right:12px; bottom:16px; background:var(--card);
          border:1px solid color-mix(in oklab,var(--fg) 10%, transparent);
          padding:12px; border-radius:12px; display:none; z-index:4; }
  ul{ padding-left:18px; margin:8px 0 0; }

  /* サジェスト */
  #suggestions{ border-radius:10px; overflow:hidden; }
  .suggest-item{ padding:10px; cursor:pointer;
    border-bottom:1px solid color-mix(in oklab,var(--fg) 10%, transparent); }
  .suggest-item:last-child{ border-bottom:none; }
  .suggest-item:active{ background:color-mix(in oklab,var(--bg) 70%, var(--card) 30%); }
</style>

<!-- cache buster -->
<script>
  const APP_VERSION = "1.5.0"; // 公開のたびに上げる
  (function(){
    const url = new URL(location.href);
    if(url.searchParams.get("v") !== APP_VERSION){
      url.searchParams.set("v", APP_VERSION);
      location.replace(url.toString());
    }
  }());
</script>
</head>
<body>
<header class="row">
  <h1>喘息注意度チェッカー</h1>
  <button id="refreshBtn">更新</button>
</header>

<main>
  <section class="card" id="statusCard">
    <div class="row">
      <div>
        <div class="muted" id="where">位置取得中…</div>
        <div class="row" style="gap:8px; margin-top:6px;">
          <span id="levelPill" class="pill">計算中…</span>
          <span class="muted" id="updated">--:-- 更新</span>
        </div>
      </div>
      <div style="min-width:140px; text-align:right;">
        <div style="font-size:42px; font-weight:800;" id="score">--</div>
        <div class="muted tiny">0 低 ←→ 100 高</div>
      </div>
    </div>

    <!-- unified: center(550,500), radius 440, start x = 110 -->
    <svg class="gauge" viewBox="0 0 1100 600" aria-hidden="true">
      <defs>
        <linearGradient id="grad" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0%"  stop-color="#12b886"/>
          <stop offset="33%" stop-color="#ffd43b"/>
          <stop offset="66%" stop-color="#ff922b"/>
          <stop offset="100%" stop-color="#fa5252"/>
        </linearGradient>
      </defs>
      <path d="M110 500 A 440 440 0 0 1 990 500"
            stroke="rgba(128,128,128,.25)" stroke-width="44" fill="none" stroke-linecap="round"/>
      <path id="arc" d="M110 500 A 440 440 0 0 1 110 500"
            stroke="url(#grad)" stroke-width="44" fill="none" stroke-linecap="round"/>
      <circle id="knob" cx="110" cy="500" r="14" fill="white" opacity=".9"/>
      <text id="labelMain" x="550" y="285" text-anchor="middle" font-size="42" font-weight="800"></text>
      <text id="labelSub"  x="550" y="330" text-anchor="middle" font-size="22" opacity=".8"></text>
    </svg>
    <div class="muted tiny">データ: Open-Meteo（気象/大気/花粉）・地名検索: ローカル辞書 + Open-Meteo + OSM</div>
  </section>

  <section class="card">
    <div class="grid">
      <div class="kpi"><span class="tiny muted">PM2.5 μg/m³</span><b id="pm25">--</b></div>
      <div class="kpi"><span class="tiny muted">オゾン μg/m³</span><b id="o3">--</b></div>
      <div class="kpi"><span class="tiny muted">湿度 %</span><b id="rh">--</b></div>
      <div class="kpi"><span class="tiny muted">気温 °C</span><b id="t">--</b></div>
      <div class="kpi"><span class="tiny muted">風速 m/s</span><b id="wind">--</b></div>
      <div class="kpi"><span class="tiny muted">気圧 hPa</span><b id="p">--</b></div>
      <div class="kpi"><span class="tiny muted">花粉</span><b id="pollen">--</b></div>
      <div class="kpi"><span class="tiny muted">UV指標</span><b id="uv">--</b></div>
    </div>
  </section>

  <section class="card">
    <b>アドバイス</b>
    <ul id="adviceList"></ul>
  </section>

  <section class="card">
    <b>次の3時間予測</b>
    <div class="grid" id="miniForecast"></div>
  </section>

  <section class="card">
    <div class="row">
      <button id="useGps">現在地で判定</button>
      <button id="openPicker">地点を指定</button>
    </div>
    <div id="picker" style="display:none; margin-top:10px;">
      <label class="tiny muted">地名・駅名で検索（例：大阪、札幌、新宿、梅田、なんば、天神 など）</label>
      <input id="placeInput" placeholder="地名を入力" style="width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;">
      <div id="suggestions" style="margin-top:6px;"></div>
    </div>
    <div class="muted tiny" style="margin-top:8px;">※参考情報。症状が強い場合は医療機関へ。</div>
  </section>
</main>

<footer class="site-footer" aria-label="サイトフッター">
  <p class="footer-title">解説・ヘルプ</p>
  <nav class="footer-row" aria-label="解説リンク">
    <a class="footer-chip" href="asthma-info.html">喘息とは</a>
    <a class="footer-chip" href="pm25-pollen.html">PM2.5と花粉</a>
    <a class="footer-chip" href="uv-ozone.html">オゾンと健康</a>
    <a class="footer-chip" href="#" onclick="window.scrollTo({top:0,behavior:'smooth'})" aria-label="ページ先頭へ">先頭へ戻る</a>
  </nav>
  <hr class="footer-sep" />
  <p class="footer-title">運営・ポリシー</p>
  <nav class="footer-row" aria-label="ポリシーリンク">
    <a class="footer-chip legal" href="privacy.html">プライバシーポリシー</a>
    <a class="footer-chip legal" href="disclaimer.html">免責事項</a>
    <a class="footer-chip legal" href="terms.html">利用規約</a>
  </nav>
</footer>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
/* ===== utils ===== */
const $ = s => document.querySelector(s);
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const fmt = n => (n==null||Number.isNaN(n)) ? "--" : Math.round(n*10)/10;
function showToast(msg){ const t=$("#toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",2200); }
function normalizeQuery(q){ return (q||"").replace(/\u3000/g," ").trim(); }

/* ===== tiny cache ===== */
function cacheKey(ns,obj){ return ns+":"+JSON.stringify(obj); }
function setCache(k,v,ttl){ try{ localStorage.setItem(k, JSON.stringify({v,exp:Date.now()+ttl})); }catch{} }
function getCache(k){ try{ const j=localStorage.getItem(k); if(!j) return null; const o=JSON.parse(j); return (o.exp>Date.now())?o.v:null; }catch{ return null; } }
async function cachedFetchJSON(url, ttlMs){
  const k = cacheKey("f",{url}); const hit = getCache(k); if(hit) return hit;
  try{ const r = await fetch(url, {headers:{'Accept':'application/json'}}); if(!r.ok) throw 0;
       const j = await r.json(); setCache(k,j,ttlMs); return j; }catch{ return {}; }
}

/* ===== popularity heuristics (だいたい) ===== */
const POP_CITY = new Map(Object.entries({
  "東京":4,"東京都":3.5,"大阪":4,"大阪市":3.8,"大阪府":3.5,"札幌":3.6,"札幌市":3.6,"京都":3.4,"名古屋":3.4,"横浜":3.5,
  "福岡":3.3,"神戸":3.2,"広島":3.0,"仙台":3.0,"那覇":2.8,"川崎":2.8,"千葉":2.6,"さいたま":2.6,"金沢":2.4
}));
const POP_HOTSPOT = new Map(Object.entries({
  "新宿":3.6,"新宿区":3.8,"渋谷":3.5,"池袋":3.3,"上野":2.6,"品川":2.4,"秋葉原":2.6,"銀座":2.6,
  "梅田":3.2,"難波":3.0,"心斎橋":2.8,"天王寺":2.6,"日本橋":2.2,"博多":3.0,"天神":3.2,"すすきの":3.0
}));
const PREF_CAPITAL = new Map(Object.entries({
  "札幌市":1.0,"仙台市":0.8,"さいたま市":0.8,"千葉市":0.7,"横浜市":1.0,"新潟市":0.6,"金沢市":0.6,"名古屋市":1.0,
  "京都市":1.0,"大阪市":1.0,"神戸市":1.0,"岡山市":0.6,"広島市":0.9,"高松市":0.5,"福岡市":1.0,"鹿児島市":0.5,"那覇市":0.7
}));
function popularityBoost(base, pref, type){
  let s = 0;
  s += POP_HOTSPOT.get(base) || 0;
  s += POP_CITY.get(base) || 0;
  if (/都$|道$|府$|県$/.test(base)) s += 1.0;
  if (/駅$/.test(base) || /station/.test(type)) s += 1.2;
  if (/市$|区$/.test(base)) s += 0.6;
  s += PREF_CAPITAL.get(base) || 0;
  if ((pref||"").includes("東京都") && /新宿|渋谷|池袋|品川|銀座/.test(base)) s += 0.6;
  if ((pref||"").includes("大阪府") && /梅田|難波|心斎橋|天王寺|新大阪/.test(base)) s += 0.6;
  return s;
}

/* ===== local prefecture & capital quick DB (+ 繁華街) ===== */
const _zen2han = s => s.replace(/[！-～]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
const _stripSuffix = s => s.replace(/(都|道|府|県|市|区|町|村|郡|駅|市区|市町村)$/u, "");
const _norm = s => _stripSuffix(_zen2han((s||"").trim()));
const LOCAL_PLACES = [
  {aliases:["北海道","札幌","札幌市"],lat:43.0621,lon:141.3544},
  {aliases:["青森県","青森","青森市"],lat:40.8222,lon:140.7474},
  {aliases:["岩手県","盛岡","盛岡市"],lat:39.7019,lon:141.1540},
  {aliases:["宮城県","仙台","仙台市","仙台駅"],lat:38.2682,lon:140.8694},
  {aliases:["秋田県","秋田","秋田市"],lat:39.7186,lon:140.1024},
  {aliases:["山形県","山形","山形市"],lat:38.2404,lon:140.3633},
  {aliases:["福島県","福島","福島市"],lat:37.7503,lon:140.4676},
  {aliases:["茨城県","水戸","水戸市"],lat:36.3659,lon:140.4712},
  {aliases:["栃木県","宇都宮","宇都宮市"],lat:36.5551,lon:139.8828},
  {aliases:["群馬県","前橋","前橋市"],lat:36.3890,lon:139.0600},
  {aliases:["埼玉県","さいたま","さいたま市"],lat:35.8617,lon:139.6455},
  {aliases:["千葉県","千葉","千葉市"],lat:35.6073,lon:140.1063},
  {aliases:["東京都","東京","東京23区","都内","東京駅","丸の内"],lat:35.6828,lon:139.7595},
  {aliases:["神奈川県","横浜","横浜市","横浜駅","みなとみらい"],lat:35.4658,lon:139.6225},
  {aliases:["新潟県","新潟","新潟市"],lat:37.9161,lon:139.0364},
  {aliases:["富山県","富山","富山市"],lat:36.6953,lon:137.2113},
  {aliases:["石川県","金沢","金沢市"],lat:36.5613,lon:136.6562},
  {aliases:["福井県","福井","福井市"],lat:36.0652,lon:136.2216},
  {aliases:["山梨県","甲府","甲府市"],lat:35.6642,lon:138.5684},
  {aliases:["長野県","長野","長野市"],lat:36.6513,lon:138.1810},
  {aliases:["岐阜県","岐阜","岐阜市"],lat:35.4233,lon:136.7607},
  {aliases:["静岡県","静岡","静岡市"],lat:34.9756,lon:138.3828},
  {aliases:["愛知県","名古屋","名古屋市","名古屋駅","名駅","栄","栄町（名古屋）","金山"],lat:35.1815,lon:136.9066},
  {aliases:["三重県","津","津市"],lat:34.7303,lon:136.5086},
  {aliases:["滋賀県","大津","大津市"],lat:35.0045,lon:135.8686},
  {aliases:["京都府","京都","京都市","河原町","四条"],lat:35.0116,lon:135.7681},
  {aliases:["大阪府","大阪","大阪市","梅田","大阪駅","なんば","難波","心斎橋","天王寺","新大阪","日本橋（大阪）"],lat:34.6937,lon:135.5023},
  {aliases:["兵庫県","神戸","神戸市","三宮","神戸三宮"],lat:34.6952,lon:135.1979},
  {aliases:["奈良県","奈良","奈良市"],lat:34.6851,lon:135.8050},
  {aliases:["和歌山県","和歌山","和歌山市"],lat:34.2305,lon:135.1708},
  {aliases:["鳥取県","鳥取","鳥取市"],lat:35.5011,lon:134.2351},
  {aliases:["島根県","松江","松江市"],lat:35.4723,lon:133.0505},
  {aliases:["岡山県","岡山","岡山市"],lat:34.6551,lon:133.9195},
  {aliases:["広島県","広島","広島市"],lat:34.3853,lon:132.4553},
  {aliases:["山口県","山口","山口市"],lat:34.1859,lon:131.4706},
  {aliases:["徳島県","徳島","徳島市"],lat:34.0703,lon:134.5548},
  {aliases:["香川県","高松","高松市"],lat:34.3428,lon:134.0466},
  {aliases:["愛媛県","松山","松山市"],lat:33.8392,lon:132.7657},
  {aliases:["高知県","高知","高知市"],lat:33.5597,lon:133.5311},
  {aliases:["福岡県","福岡","福岡市","天神","中洲","博多駅"],lat:33.5902,lon:130.4017},
  {aliases:["佐賀県","佐賀","佐賀市"],lat:33.2635,lon:130.3009},
  {aliases:["長崎県","長崎","長崎市"],lat:32.7503,lon:129.8777},
  {aliases:["熊本県","熊本","熊本市"],lat:32.7898,lon:130.7417},
  {aliases:["大分県","大分","大分市"],lat:33.2396,lon:131.6093},
  {aliases:["宮崎県","宮崎","宮崎市"],lat:31.9111,lon:131.4239},
  {aliases:["鹿児島県","鹿児島","鹿児島市"],lat:31.5966,lon:130.5571},
  {aliases:["沖縄県","那覇","那覇市","国際通り"],lat:26.2124,lon:127.6809},
  // 東京繁華街
  {aliases:["新宿","新宿区","新宿駅"],lat:35.6938,lon:139.7034},
  {aliases:["渋谷","渋谷区","渋谷駅"],lat:35.6595,lon:139.7005},
  {aliases:["池袋","池袋駅"],lat:35.7295,lon:139.7100},
  {aliases:["品川","品川駅"],lat:35.6285,lon:139.7389},
  {aliases:["銀座"],lat:35.6717,lon:139.7650},
  {aliases:["上野","上野駅"],lat:35.7138,lon:139.7773},
  {aliases:["秋葉原"],lat:35.6984,lon:139.7730},
  // 札幌繁華街
  {aliases:["すすきの","大通","札幌駅"],lat:43.0554,lon:141.3400},
];
function localCandidates(raw){
  const q = _norm(raw);
  if (!q || q.length < 1) return [];
  const res = [];
  for (const it of LOCAL_PLACES){
    for (const al of it.aliases){
      const a = _norm(al);
      if (q === a || a.startsWith(q) || q.startsWith(a) || a.includes(q)){
        const title = `${al.replace(/市$/,"")}, 日本`;
        const boost = /都|道|府|県$/.test(al) ? 140 : 130;
        res.push({name:title,lat:it.lat,lon:it.lon,score:boost});
        break;
      }
    }
  }
  const seen=new Set(), out=[];
  for(const r of res){ if(!seen.has(r.name)){ seen.add(r.name); out.push(r);} }
  out.sort((a,b)=>b.score-a.score);
  return out.slice(0,8);
}

/* ===== geocoding with local-first + popularity sort ===== */
async function fetchJSONTimeout(url, {timeout=4000, headers={}}={}){
  const ctrl = new AbortController(); const id = setTimeout(()=>ctrl.abort(), timeout);
  try{ const res = await fetch(url, {signal:ctrl.signal, headers}); if(!res.ok) throw 0; return await res.json(); }
  finally{ clearTimeout(id); }
}
async function geocode(raw){
  const term = normalizeQuery(raw);
  if (term.length < 1) return [];

  // 1) ローカル辞書で即時候補
  const local = localCandidates(term);
  if (local.length) return local;

  // 2) オンライン検索
  const omURL  = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(term)}&count=12&language=ja&format=json`;
  const nomURL = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=20&countrycodes=jp&addressdetails=1&namedetails=1&extratags=1&q=${encodeURIComponent(term)}`;

  const [omRes, nomRes] = await Promise.allSettled([
    fetchJSONTimeout(omURL,{timeout:3500}),
    fetchJSONTimeout(nomURL,{timeout:4000,headers:{'Accept':'application/json','User-Agent':'AsthmaChecker/1.0 (edu)'}})
  ]);

  let cand = [];

  if (omRes.status==="fulfilled" && omRes.value?.results?.length){
    cand.push(...omRes.value.results.map(r=>{
      const base = r.name; const pref = r.admin1 || "";
      let s = (r.population? Math.log10(r.population)*2 : 0)
            + (r.feature_code?.startsWith("PPL")? 1.0 : 0)
            + (base===term ? 1.0 : 0)
            + popularityBoost(base, pref, "place");
      return {name:[base,pref,r.country].filter(Boolean).join(", "),lat:r.latitude,lon:r.longitude,score:s};
    }));
  }

  if (nomRes.status==="fulfilled" && Array.isArray(nomRes.value)){
    const allowType = new Set([
      'city','borough','suburb','quarter','neighbourhood',
      'town','village','hamlet','ward','municipality',
      'county','district','city_district',
      'state','province','region','administrative',
      'locality','island',
      'station','train_station','bus_station','subway_entrance'
    ]);
    cand.push(...nomRes.value.map(r=>{
      const addr=r.address||{};
      const pref = addr.state || addr.province || addr.region || "";
      const city = addr.city || addr.town || addr.village || addr.municipality || addr.county || "";
      const base = r.namedetails?.name || r.display_name?.split(',')[0] || term;
      const type = r.type || ''; const admin = Number(r.extratags?.admin_level || 0);
      let s = (r.importance||0)*4 + popularityBoost(base, pref, type);
      const pop = Number(r.extratags?.population || 0);
      if (pop) s += Math.log10(pop) * 2;
      if (/駅$/.test(base)) s += 0.8;
      if (base===term) s += 1.0;
      if (/(state|region|administrative)/.test(type) || admin===4) if (/(都|道|府|県)$/.test(term)) s += 2.0;
      return {name:[base, pref||city||"", "日本"].filter(Boolean).join(", "), lat:+r.lat, lon:+r.lon, score:s, keep:allowType.has(type)};
    }).filter(x=>x.keep));
  }

  const dedupe = rows => {
    const m=new Map(); rows.forEach(r=>{ const k=r.name.replace(/, 日本$/,""); if(!m.has(k)) m.set(k,r); });
    return [...m.values()];
  };

  cand = dedupe(cand).sort((a,b)=>b.score-a.score);

  // 保険：まだ空ならローカルをゆるく
  if (!cand.length){
    const loose = localCandidates(term.slice(0, Math.max(1, Math.min(3, term.length-1))));
    if (loose.length) return loose;
  }

  return cand.slice(0,8);
}

/* ===== data fetch ===== */
function pickIndex(times){
  if (!times || !times.length) return -1;
  const ms = times.map(t => new Date(t.replace("T"," ") + ":00").getTime());
  const now = Date.now();
  let best = -1, bestDiff = Infinity;
  for (let i=0;i<ms.length;i++){
    if (ms[i] <= now){
      const d = now - ms[i];
      if (d < bestDiff){ best = i; bestDiff = d; }
    }
  }
  if (best === -1){
    best = ms.reduce((bi,v,i)=> Math.abs(v-now) < Math.abs(ms[bi]-now) ? i : bi, 0);
  }
  return best;
}
async function fetchAll(lat, lon){
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "Asia/Tokyo";
  const tzEnc = encodeURIComponent(tz);
  const aq = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5,ozone,uv_index&timezone=${tzEnc}`;
  const wx = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relative_humidity_2m,pressure_msl,wind_speed_10m&timezone=${tzEnc}`;
  const pl = `https://pollen-api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=grass_pollen,birch_pollen,ragweed_pollen&timezone=${tzEnc}`;

  const TTL = 10*60*1000;
  let aqJ={}, wxJ={}, plJ={};
  try{ aqJ = await cachedFetchJSON(aq, TTL); }catch{}
  try{ wxJ = await cachedFetchJSON(wx, TTL); }catch{}
  try{ plJ = await cachedFetchJSON(pl, TTL); }catch{}

  const times = aqJ?.hourly?.time || wxJ?.hourly?.time || [];
  const idx = pickIndex(times);
  function pick(o,k){ const arr=o?.hourly?.[k]||[]; return (idx>=0 && idx<arr.length)?arr[idx]:null; }

  const mini = [1,2,3].map(i=>{
    const j = idx + i;
    if (j < times.length) return {
      hh: times[j].slice(11,16),
      pm25: aqJ?.hourly?.pm2_5?.[j],
      o3:   aqJ?.hourly?.ozone?.[j],
      rh:   wxJ?.hourly?.relative_humidity_2m?.[j],
      wind: wxJ?.hourly?.wind_speed_10m?.[j]
    };
    return null;
  }).filter(Boolean);

  return {
    pm25: pick(aqJ,"pm2_5"), o3: pick(aqJ,"ozone"), uv: pick(aqJ,"uv_index"),
    t: pick(wxJ,"temperature_2m"), rh: pick(wxJ,"relative_humidity_2m"),
    wind: pick(wxJ,"wind_speed_10m"), p: pick(wxJ,"pressure_msl"),
    grass: pick(plJ,"grass_pollen"), birch: pick(plJ,"birch_pollen"), rag: pick(plJ,"ragweed_pollen"),
    mini
  };
}

/* ===== scoring / advice ===== */
function computeScore(d){
  let pts=0;
  if(d.pm25!=null){const x=d.pm25; pts += (x<=12?2:x<=25?10:x<=35?18:x<=55?28:x<=90?35:40);}
  if(d.o3!=null){const x=d.o3;  pts += (x<=60?2:x<=100?8:x<=140?14:18);}
  const pol=[d.grass,d.birch,d.rag].filter(v=>v!=null);
  if(pol.length){const x=Math.max(...pol); pts += (x<=10?2:x<=50?8:x<=150?14:18);}
  if(d.rh!=null){const x=d.rh; pts += (x<30||x>85?8:(x<40||x>75?4:0));}
  if(d.t!=null){const x=d.t; pts += (x<5||x>32?6:(x<10||x>28?3:0));}
  if(d.wind!=null){const x=d.wind; pts += (x>12?6:(x>8?3:0));}
  if(d.p!=null){const x=d.p; pts += (x<1000?4:(x<1005?2:0));}
  if(d.uv!=null){const x=d.uv; pts += (x>7?4:(x>5?2:0));}
  return clamp(Math.round(pts),0,100);
}
function levelFromScore(s){
  if(s<25) return {label:"低い",cls:"low"};
  if(s<50) return {label:"中程度",cls:"mod"};
  if(s<75) return {label:"高い",cls:"high"};
  return {label:"非常に高い",cls:"vhi"};
}
function buildAdvice(s,d){
  const L = levelFromScore(s).label, a=[];
  if(L==="低い"){ a.push("通常どおり活動可。吸入薬は携帯。"); }
  else if(L==="中程度"){ a.push("屋外運動は控えめに。マスク携帯を。"); if(d.pm25>35) a.push("PM2.5やや高：洗濯物は部屋干し推奨。"); }
  else if(L==="高い"){ a.push("外出短時間・人混み回避。"); if(d.wind>8) a.push("強風：花粉/粉じん対策を。"); }
  else { a.push("できるだけ屋内で。窓を閉め空気清浄機を強めに。"); a.push("症状悪化時は早めに受診/相談。"); }
  return a;
}

/* ===== gauge drawing ===== */
function setArc(score){
  const pct = clamp(score,0,100) / 100;
  const R=440, cx=550, cy=500;
  const ex = cx + R*Math.cos(Math.PI - Math.PI*pct);
  const ey = cy - R*Math.sin(Math.PI - Math.PI*pct);
  $("#arc").setAttribute("d", `M110 500 A 440 440 0 0 1 ${ex.toFixed(1)} ${ey.toFixed(1)}`);
  $("#knob").setAttribute("cx", ex.toFixed(1));
  $("#knob").setAttribute("cy", ey.toFixed(1));
}
function setPill(el,level){ el.className = "pill " + ({低い:"low",中程度:"mod",高い:"high",非常に高い:"vhi"}[level]||"low"); el.textContent = level; }

/* ===== main update ===== */
async function update(lat,lon,label="この周辺"){
  $("#where").textContent = label;
  $("#levelPill").textContent = "計算中…";
  $("#score").textContent = "--";
  $("#labelMain").textContent = ""; $("#labelSub").textContent = "";

  const d = await fetchAll(lat,lon);

  $("#pm25").textContent = fmt(d.pm25);
  $("#o3").textContent   = fmt(d.o3);
  $("#rh").textContent   = fmt(d.rh);
  $("#t").textContent    = fmt(d.t);
  $("#wind").textContent = fmt(d.wind);
  $("#p").textContent    = fmt(d.p);
  const pollenTxt=(d.grass??d.birch??d.rag)==null?"—":
    (Math.max(d.grass||0,d.birch||0,d.rag||0)<=10?"低":
     Math.max(d.grass||0,d.birch||0,d.rag||0)<=50?"中":
     Math.max(d.grass||0,d.birch||0,d.rag||0)<=150?"高":"非常に高");
  $("#pollen").textContent = pollenTxt;
  $("#uv").textContent = fmt(d.uv);

  const score = computeScore(d);
  const L = levelFromScore(score);
  $("#score").textContent = score;
  setPill($("#levelPill"), L.label);
  $("#labelMain").textContent = L.label;
  $("#labelSub").textContent  = `総合スコア ${score}`;
  setArc(score);
  $("#updated").textContent = new Date().toTimeString().slice(0,5) + " 更新";

  $("#adviceList").innerHTML = buildAdvice(score,d).map(s=>`<li>${s}</li>`).join("");
  $("#miniForecast").innerHTML = d.mini.map(m=>`
    <div class="kpi">
      <span class="tiny muted">${m.hh}</span>
      <div class="tiny">PM2.5 ${fmt(m.pm25)} / O3 ${fmt(m.o3)}</div>
      <div class="tiny">湿度 ${fmt(m.rh)}%・風 ${fmt(m.wind)}m/s</div>
    </div>`).join("");
}

/* ===== GPS ===== */
async function useGPS(){
  const btn=$("#useGps"); btn.classList.add("loading");
  if(!navigator.geolocation){ showToast("この端末では位置情報が使えません"); btn.classList.remove("loading"); return; }
  showToast("位置情報を取得中…");
  navigator.geolocation.getCurrentPosition(
    pos=>{ update(pos.coords.latitude.toFixed(4), pos.coords.longitude.toFixed(4), "現在地"); btn.classList.remove("loading"); },
    _  =>{ showToast("位置情報が拒否されました。地名検索をご利用ください。"); btn.classList.remove("loading"); },
    {enableHighAccuracy:true, timeout:8000, maximumAge:120000}
  );
}

/* ===== search input: debounce + latest-only render ===== */
let qTimer = null, lastReqId = 0;
$("#placeInput").addEventListener("input", e=>{
  const box = $("#suggestions");
  const raw = e.target.value;
  if (qTimer) clearTimeout(qTimer);

  qTimer = setTimeout(async ()=>{
    const reqId = ++lastReqId;
    const q = normalizeQuery(raw);
    if (q.length < 1){ if(reqId===lastReqId) box.innerHTML=""; return; }

    box.innerHTML = `<div class="tiny muted">検索中…</div>`;
    const list = await geocode(q);

    if (reqId !== lastReqId) return; // 最新のみ描画

    if(!list.length){
      box.innerHTML = `<div class="tiny muted">見つかりませんでした</div>`;
      return;
    }
    box.innerHTML = list.map(r=>`<div class="suggest-item" data-lat="${r.lat}" data-lon="${r.lon}">${r.name}</div>`).join("");
    box.querySelectorAll(".suggest-item").forEach(div=>div.addEventListener("click", ()=>{
      const lat=+div.dataset.lat, lon=+div.dataset.lon;
      update(lat,lon,div.textContent);
      $("#picker").style.display="none"; $("#openPicker").classList.remove("activeTab");
    }));
  }, 250);
});

/* ===== UI wiring ===== */
$("#refreshBtn").addEventListener("click", ()=>{ useGPS(); });
$("#useGps").addEventListener("click", useGPS);
$("#openPicker").addEventListener("click", ()=>{
  const p=$("#picker"); const b=$("#openPicker");
  const open = p.style.display !== "none";
  p.style.display = open ? "none" : "block";
  b.classList.toggle("activeTab", !open);
});

/* ===== init ===== */
document.addEventListener("DOMContentLoaded", ()=>{ useGPS(); });
</script>
</body>
</html>
