<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>喘息注意度チェッカー</title>
<meta name="theme-color" content="#0b3d5c" />
<style>
  :root{
    --bg:#0b1116; --fg:#e9f1f5; --muted:#9bb3bf; --card:#121a21;
    --ok:#12b886; --med:#ffd43b; --hi:#ff922b; --vhi:#fa5252; --accent:#2a84ff;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f5fbff; --fg:#0c1b24; --muted:#5b7480; --card:#ffffff; }
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
        background:var(--bg); color:var(--fg); }
  header{ padding:16px; position:sticky; top:0; backdrop-filter:saturate(1.2) blur(6px);
          background:color-mix(in oklab, var(--bg) 84%, transparent); border-bottom:1px solid color-mix(in oklab,var(--fg) 12%, transparent);}
  h1{ font-size:18px; margin:0; }
  main{ padding:16px; display:grid; gap:16px; max-width:720px; margin:0 auto; }
  .card{ background:var(--card); border:1px solid color-mix(in oklab,var(--fg) 10%, transparent);
         border-radius:14px; padding:14px; }
  .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  button{ font-size:16px; padding:10px 14px; border-radius:12px; border:1px solid color-mix(in oklab,var(--fg) 10%, transparent);
          background:color-mix(in oklab,var(--bg) 70%, var(--card) 30%); color:var(--fg); }
  button:active{ transform:scale(0.98); }
  .muted{ color:var(--muted); font-size:13px; }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .kpi{ display:flex; flex-direction:column; gap:4px; padding:10px; border-radius:12px;
        background:color-mix(in oklab,var(--card) 70%, var(--bg) 30%); }
  .kpi b{ font-size:18px; }
  .pill{ padding:4px 10px; border-radius:999px; font-weight:700; font-size:13px; }
  .pill.low{ background:color-mix(in oklab, var(--ok) 25%, transparent); color: var(--ok);}
  .pill.mod{ background:color-mix(in oklab, var(--med) 25%, transparent); color: #a07b00;}
  .pill.high{ background:color-mix(in oklab, var(--hi) 25%, transparent); color:#a35300;}
  .pill.vhi{ background:color-mix(in oklab, var(--vhi) 25%, transparent); color:#8a0b0b;}
  .gauge{ width:100%; aspect-ratio:2.2/1; }
  .advice li{ margin:6px 0; }
  .tiny{ font-size:12px; }
  .toast{ position:fixed; left:12px; right:12px; bottom:16px; background:var(--card);
          border:1px solid color-mix(in oklab,var(--fg) 10%, transparent); padding:12px; border-radius:12px; display:none; }
  .results{ margin:8px 0 0; padding:0; list-style:none; max-height:220px; overflow:auto; }
  .results li{ margin:6px 0; }
  .results button{ width:100%; text-align:left; padding:8px 12px; border-radius:10px; }
  .results .tiny{ opacity:.8; font-size:12px; display:block; }
</style>
</head>
<body>
<header class="row">
  <h1>喘息注意度チェッカー</h1>
  <div class="row" style="gap:6px;">
    <button id="refreshBtn">更新</button>
    <button id="useGps">現在地</button>
    <button id="openPicker">地点を指定</button>
  </div>
</header>

<main>
  <section class="card" id="statusCard">
    <div class="row">
      <div>
        <div class="muted" id="where">位置取得中…</div>
        <div style="margin-top:6px;">
          <span id="levelPill" class="pill">計算中…</span>
          <span class="muted tiny" id="updated">--:-- 更新</span>
        </div>
      </div>
      <div style="min-width:140px; text-align:right;">
        <div style="font-size:42px; font-weight:800;" id="score">--</div>
        <div class="muted tiny">0 低 ←→ 100 高</div>
      </div>
    </div>
    <svg class="gauge" viewBox="0 0 1000 450" aria-hidden="true">
      <defs><linearGradient id="grad" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%" stop-color="#12b886"/><stop offset="33%" stop-color="#ffd43b"/>
        <stop offset="66%" stop-color="#ff922b"/><stop offset="100%" stop-color="#fa5252"/>
      </linearGradient></defs>
      <path d="M80 360 A 420 420 0 0 1 920 360" stroke="rgba(128,128,128,.25)" stroke-width="44" fill="none" stroke-linecap="round"/>
      <path id="arc" d="M80 360 A 420 420 0 0 1 80 360" stroke="url(#grad)" stroke-width="44" fill="none" stroke-linecap="round"/>
      <circle id="knob" cx="80" cy="360" r="14" fill="white" opacity=".9"/>
      <text id="labelMain" x="500" y="245" text-anchor="middle" font-size="42" font-weight="800"></text>
      <text id="labelSub" x="500" y="285" text-anchor="middle" font-size="24" opacity=".8"></text>
    </svg>
    <div class="muted tiny">データ: Open-Meteo</div>
  </section>

  <section class="card">
    <div class="grid">
      <div class="kpi"><span class="muted tiny">PM2.5</span><b id="pm25">--</b></div>
      <div class="kpi"><span class="muted tiny">O3</span><b id="o3">--</b></div>
      <div class="kpi"><span class="muted tiny">湿度%</span><b id="rh">--</b></div>
      <div class="kpi"><span class="muted tiny">気温℃</span><b id="t">--</b></div>
      <div class="kpi"><span class="muted tiny">風速m/s</span><b id="wind">--</b></div>
      <div class="kpi"><span class="muted tiny">気圧hPa</span><b id="p">--</b></div>
      <div class="kpi"><span class="muted tiny">花粉</span><b id="pollen">--</b></div>
      <div class="kpi"><span class="muted tiny">UV</span><b id="uv">--</b></div>
    </div>
  </section>

  <section class="card"><b>アドバイス</b><ul id="adviceList"></ul></section>
  <section class="card"><b>1時間ごとの見通し（次の3時間）</b><div class="grid" id="miniForecast"></div></section>

  <section class="card" id="picker" style="display:none;">
    <label class="tiny muted">地名・駅名・住所で検索</label>
    <div class="row"><input id="place" style="flex:1; padding:10px;" placeholder="例: 新宿, 大阪市"/><button id="search">検索</button></div>
    <ul id="results" class="results"></ul>
  </section>
</main>

<div class="toast" id="toast"></div>

<script>
// ---- キャッシュユーティリティ ----
const MemCache = new Map();
function cacheKey(url){ return "fetch:"+url; }
function setCache(url, value, ttl){ const until=Date.now()+ttl; MemCache.set(url,{until,value}); localStorage.setItem(cacheKey(url),JSON.stringify({until,value})); }
function getCache(url){ const k=cacheKey(url), now=Date.now(); const m=MemCache.get(url); if(m&&m.until>now) return m.value; try{const o=JSON.parse(localStorage.getItem(k)||"{}"); if(o.until>now){MemCache.set(url,o); return o.value;} localStorage.removeItem(k);}catch{} return null; }
async function cachedFetchJSON(url,ttl){ const hit=getCache(url); if(hit) return hit; try{const r=await fetch(url); if(!r.ok) throw 0; const j=await r.json(); setCache(url,j,ttl); return j;}catch(e){console.error("fetch失敗",url); return{};} }

// ---- データ取得 ----
async function fetchAll(lat,lon){
  const tz=Intl.DateTimeFormat().resolvedOptions().timeZone||"Asia/Tokyo";
  const base=`lat=${lat}&longitude=${lon}&timezone=${encodeURIComponent(tz)}`;
  const aq=`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5,ozone,uv_index&timezone=${tz}`;
  const wx=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relative_humidity_2m,pressure_msl,wind_speed_10m&timezone=${tz}`;
  const pl=`https://pollen-api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=grass_pollen,birch_pollen,ragweed_pollen&timezone=${tz}`;
  const ttl=10*60*1000;
  const [aqJ,wxJ,plJ]=await Promise.all([cachedFetchJSON(aq,ttl),cachedFetchJSON(wx,ttl),cachedFetchJSON(pl,ttl)]);
  const nowISO=new Date().toISOString().slice(0,13);
  function pick(o,k){const arrT=o?.hourly?.time||[];const i=arrT.findIndex(t=>t.startsWith(nowISO));return i>=0?o.hourly[k]?.[i]:null;}
  return {pm25:pick(aqJ,"pm2_5"),o3:pick(aqJ,"ozone"),uv:pick(aqJ,"uv_index"),
          t:pick(wxJ,"temperature_2m"),rh:pick(wxJ,"relative_humidity_2m"),
          wind:pick(wxJ,"wind_speed_10m"),p:pick(wxJ,"pressure_msl"),
          grass:pick(plJ,"grass_pollen"),birch:pick(plJ,"birch_pollen"),rag:pick(plJ,"ragweed_pollen"),
          mini:(()=>{const ts=wxJ?.hourly?.time||[];const i=ts.findIndex(t=>t.startsWith(nowISO));return [i+1,i+2,i+3].map(j=>({hh:ts[j]?.slice(11,16),pm25:aqJ?.hourly?.pm2_5?.[j],o3:aqJ?.hourly?.ozone?.[j],rh:wxJ?.hourly?.relative_humidity_2m?.[j],wind:wxJ?.hourly?.wind_speed_10m?.[j]}));})()};
}

// ---- スコア計算（簡略） ----
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function computeScore(d){let s=0;if(d.pm25!=null)s+=d.pm25>35?30:d.pm25>15?15:5;if(d.o3!=null)s+=d.o3>100?15:d.o3>60?8:2;if(d.rh!=null)(d.rh<40||d.rh>75)?s+=5:0;if(d.t!=null)(d.t<10||d.t>30)?s+=5:0;if(d.wind!=null&&d.wind>8)s+=5;if(d.p!=null&&d.p<1005)s+=3; if(d.uv!=null&&d.uv>6)s+=4;if(d.grass||d.birch||d.rag){const x=Math.max(d.grass||0,d.birch||0,d.rag||0);s+=x>50?15:x>10?8:2;} return clamp(s,0,100);}
function level(s){if(s<25)return["低い","low"];if(s<50)return["中程度","mod"];if(s<75)return["高い","high"];return["非常に高い","vhi"];}

// ---- UI 更新 ----
function showToast(msg){const t=document.querySelector("#toast");t.textContent=msg;t.style.display="block";setTimeout(()=>t.style.display="none",2500);}
async function update(lat,lon,label="地点"){document.querySelector("#where").textContent=label;const d=await fetchAll(lat,lon);document.querySelector("#pm25").textContent=d.pm25??"--";document.querySelector("#o3").textContent=d.o3??"--";document.querySelector("#rh").textContent=d.rh??"--";document.querySelector("#t").textContent=d.t??"--";document.querySelector("#wind").textContent=d.wind??"--";document.querySelector("#p").textContent=d.p??"--";document.querySelector("#uv").textContent=d.uv??"--";document.querySelector("#pollen").textContent=(d.grass||d.birch||d.rag)?(Math.max(d.grass||0,d.birch||0,d.rag||0)>50?"高":"中"):"--";const score=computeScore(d);const [lab,cls]=level(score);document.querySelector("#score").textContent=score;document.querySelector("#levelPill").className="pill "+cls;document.querySelector("#levelPill").textContent=lab;document.querySelector("#labelMain").textContent=lab;document.querySelector("#labelSub").textContent=`総合 ${score}`;document.querySelector("#updated").textContent=new Date().toTimeString().slice(0,5)+" 更新";document.querySelector("#adviceList").innerHTML=lab==="低い"?"<li>通常どおり活動可</li>":"<li>外出は控えめに</li>";document.querySelector("#miniForecast").innerHTML=d.mini.map(m=>`<div class="kpi"><span>${m.hh||"--"}</span><span class="tiny">PM2.5 ${m.pm25??"--"}</span></div>`).join("");}

// ---- GPS ----
document.querySelector("#useGps").onclick=()=>{if(!navigator.geolocation){showToast("位置情報NG");return;}navigator.geolocation.getCurrentPosition(p=>update(p.coords.latitude,p.coords.longitude,"現在地"),()=>showToast("位置情報が拒否されました"));};

// ---- 地名検索 ----
async function geocode(q){if(!q)return[];const url=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=5&language=ja&format=json`;const j=await cachedFetchJSON(url,3600*1000);return j.results||[];}
function shortLabel(n){return [n.name,n.admin1,n.country].filter(Boolean).join(", ");}
document.querySelector("#search").onclick=async()=>{const q=document.querySelector("#place").value.trim();const res=await geocode(q);const ul=document.querySelector("#results");if(!res.length){ul.innerHTML="<li class='muted tiny'>見つかりません</li>";return;}ul.innerHTML=res.map(r=>`<li><button data-lat="${r.latitude}" data-lon="${r.longitude}" data-name="${shortLabel(r)}">${shortLabel(r)}</button></li>`).join("");ul.querySelectorAll("button").forEach(b=>b.onclick=()=>update(b.dataset.lat,b.dataset.lon,b.dataset.name));};
document.querySelector("#openPicker").onclick=()=>{const p=document.querySelector("#picker");p.style.display=p.style.display==="none"?"block":"none";};
document.querySelector("#refreshBtn").onclick=()=>showToast("再読込: 地点を指定してください");

// 初期
update(35.68,139.76,"東京周辺");
</script>
</body>
</html>
